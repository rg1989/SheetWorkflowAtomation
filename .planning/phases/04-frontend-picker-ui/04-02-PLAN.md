---
phase: 04-frontend-picker-ui
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/components/WorkflowWizard/steps/FilesStep.tsx
  - frontend/src/components/WorkflowWizard/WorkflowWizard.tsx
autonomous: false

must_haves:
  truths:
    - "User can open Google Picker popup and browse their Drive files"
    - "User can select a Drive file and it appears as a file card in the wizard"
    - "User can mix Drive files and local uploads as workflow inputs"
    - "Users without Drive scopes see Connect Google Drive button that redirects to OAuth"
    - "Selected Drive files show metadata (name, source badge) in file cards"
  artifacts:
    - path: "frontend/src/components/WorkflowWizard/steps/FilesStep.tsx"
      provides: "Dual-source file input with local upload and Drive picker"
      contains: "DriveFilePicker"
    - path: "frontend/src/components/WorkflowWizard/WorkflowWizard.tsx"
      provides: "handleAddDriveFile callback for Drive file additions"
      contains: "handleAddDriveFile|source.*drive"
  key_links:
    - from: "frontend/src/components/WorkflowWizard/steps/FilesStep.tsx"
      to: "DriveFilePicker component"
      via: "import and render in upload zone"
      pattern: "DriveFilePicker"
    - from: "frontend/src/components/WorkflowWizard/steps/FilesStep.tsx"
      to: "AuthContext"
      via: "useAuth() for driveConnected check"
      pattern: "useAuth|driveConnected"
    - from: "frontend/src/components/WorkflowWizard/WorkflowWizard.tsx"
      to: "FileDefinition with source field"
      via: "handleAddDriveFile sets source: 'drive'"
      pattern: "source.*drive"
---

<objective>
Integrate Google Picker into the existing workflow wizard FilesStep, enabling users to select Drive files alongside local uploads. Add the "Connect Google Drive" flow for users who haven't granted Drive scopes yet.

Purpose: This is the user-facing integration that delivers the visible requirements (SELECT-01, SELECT-03, SELECT-04). All foundation pieces from Plan 01 are wired into the existing UI.
Output: Updated FilesStep with dual-source input and WorkflowWizard with Drive file handling.
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-picker-ui/04-RESEARCH.md
@.planning/phases/04-frontend-picker-ui/04-01-SUMMARY.md
@frontend/src/components/WorkflowWizard/steps/FilesStep.tsx
@frontend/src/components/WorkflowWizard/WorkflowWizard.tsx
@frontend/src/components/WorkflowWizard/FileCard.tsx
@frontend/src/types/index.ts
@frontend/src/context/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WorkflowWizard to handle Drive file additions</name>
  <files>
    frontend/src/components/WorkflowWizard/WorkflowWizard.tsx
  </files>
  <action>
Add a new `handleAddDriveFile` callback in WorkflowWizard.tsx that creates a FileDefinition from Drive file metadata (no File object needed).

**Add the callback** after the existing `handleAddFile` function:

```typescript
const handleAddDriveFile = useCallback(
  (params: {
    name: string
    filename: string
    columns: ColumnInfo[]
    sampleData?: Record<string, unknown>[]
    driveFileId: string
    driveMimeType: string
    driveModifiedTime?: string
  }) => {
    setFiles((prev) => {
      if (prev.length >= MAX_FILES) {
        setError(`Maximum of ${MAX_FILES} files allowed`)
        return prev
      }

      const usedColorIndices = prev.map((f) => f.colorIndex)
      const colorIndex = getNextColorIndex(usedColorIndices)

      const newFile: FileDefinition = {
        id: generateId(),
        name: params.name,
        filename: params.filename,
        colorIndex,
        columns: params.columns,
        sampleData: params.sampleData,
        headerRow: 1,
        source: 'drive',
        driveFileId: params.driveFileId,
        driveMimeType: params.driveMimeType,
        driveModifiedTime: params.driveModifiedTime,
        // No originalFile for Drive files -- re-parsing goes through backend
      }

      setError(null)
      return [...prev, newFile]
    })
  },
  []
)
```

**Update the FilesStep rendering** in `renderStep()` case 0 to pass the new callback:

```typescript
case 0:
  return (
    <FilesStep
      files={files}
      onAddFile={handleAddFile}
      onAddDriveFile={handleAddDriveFile}
      onRemoveFile={handleRemoveFile}
      onUpdateFileName={handleUpdateFileName}
      onUpdateFileSheet={handleUpdateFileSheet}
      onUpdateFileHeaderRow={handleUpdateFileHeaderRow}
    />
  )
```

**Important:** The existing `handleAddFile` remains unchanged for local uploads. `handleAddDriveFile` is a separate callback because Drive files have different parameters (no `File` object, but has `driveFileId`).
  </action>
  <verify>
1. Run `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
2. Verify `handleAddDriveFile` callback exists in WorkflowWizard.tsx
3. Verify `onAddDriveFile` prop is passed to FilesStep
  </verify>
  <done>
- handleAddDriveFile callback added to WorkflowWizard
- Creates FileDefinition with source: 'drive' and Drive metadata fields
- FilesStep receives onAddDriveFile prop
- Existing local file handling unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Drive picker into FilesStep with dual-source input</name>
  <files>
    frontend/src/components/WorkflowWizard/steps/FilesStep.tsx
  </files>
  <action>
Update FilesStep to show both local upload and Drive picker options, with a "Connect Google Drive" button for users who haven't granted Drive scopes.

**Step 1: Update the FilesStepProps interface.**

Add `onAddDriveFile` to the props:

```typescript
interface FilesStepProps {
  files: FileDefinition[]
  onAddFile: (file: File, columns: ColumnInfo[], sampleData?: Record<string, unknown>[], sheetName?: string, availableSheets?: string[], headerRow?: number) => void
  onAddDriveFile: (params: {
    name: string
    filename: string
    columns: ColumnInfo[]
    sampleData?: Record<string, unknown>[]
    driveFileId: string
    driveMimeType: string
    driveModifiedTime?: string
  }) => void
  onRemoveFile: (fileId: string) => void
  onUpdateFileName: (fileId: string, name: string) => void
  onUpdateFileSheet: (fileId: string, columns: ColumnInfo[], sampleData?: Record<string, unknown>[], sheetName?: string) => void
  onUpdateFileHeaderRow: (fileId: string, columns: ColumnInfo[], sampleData?: Record<string, unknown>[], headerRow?: number) => void
}
```

**Step 2: Import new dependencies.**

Add at top of file:
```typescript
import { Cloud } from 'lucide-react'
import { useAuth } from '../../../context/AuthContext'
import { DriveFilePicker } from '../DriveFilePicker'
```

**Step 3: Add auth context and Drive error handling inside the component.**

Inside `FilesStep` function, add:
```typescript
const { driveConnected, loginWithDrive } = useAuth()
```

Also add the Drive error handler:
```typescript
const handleDriveError = useCallback((errorMessage: string) => {
  setError(errorMessage)
}, [])
```

**Step 4: Replace the upload zone with a dual-source layout.**

Replace the existing upload zone section (`{/* Upload zone */}` block, the `{canAddMore && (` section) with a new layout that shows both options side by side:

```tsx
{/* File source options */}
{canAddMore && (
  <div className="space-y-4">
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {/* Local upload option */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        className={cn(
          'relative border-2 border-dashed rounded-xl p-6 text-center transition-all duration-200 cursor-pointer',
          isDragging
            ? 'border-primary-500 bg-primary-50'
            : 'border-slate-300 hover:border-slate-400 hover:bg-slate-50',
          isUploading && 'pointer-events-none opacity-50'
        )}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        onClick={() => document.getElementById('file-input')?.click()}
      >
        <input
          id="file-input"
          type="file"
          accept=".xlsx,.xls"
          multiple
          onChange={handleFileInput}
          className="hidden"
        />

        <motion.div
          animate={isDragging ? { scale: 1.05 } : { scale: 1 }}
          className="flex flex-col items-center"
        >
          <div
            className={cn(
              'w-12 h-12 rounded-full flex items-center justify-center mb-3 transition-colors duration-200',
              isDragging ? 'bg-primary-100' : 'bg-slate-100'
            )}
          >
            {isUploading ? (
              <motion.div
                animate={{ rotate: 360 }}
                transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}
              >
                <FileSpreadsheet className="w-6 h-6 text-slate-500" />
              </motion.div>
            ) : (
              <Upload className={cn('w-6 h-6', isDragging ? 'text-primary-600' : 'text-slate-500')} />
            )}
          </div>

          <p className="font-medium text-slate-700 mb-1">
            {isUploading ? 'Processing...' : isDragging ? 'Drop files here' : 'Upload from Computer'}
          </p>
          <p className="text-sm text-slate-500">
            Drop Excel files or click to browse
          </p>
        </motion.div>
      </motion.div>

      {/* Drive picker option */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.05 }}
      >
        {driveConnected ? (
          <DriveFilePicker
            onFileReady={onAddDriveFile}
            onError={handleDriveError}
            disabled={!canAddMore || isUploading}
          />
        ) : (
          <button
            onClick={loginWithDrive}
            className="flex flex-col items-center gap-3 p-6 border-2 border-slate-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors w-full h-full justify-center"
          >
            <Cloud className="w-8 h-8 text-slate-400" />
            <div>
              <div className="font-medium text-slate-900">Connect Google Drive</div>
              <div className="text-sm text-slate-500">
                Grant access to select files from Drive
              </div>
            </div>
          </button>
        )}
      </motion.div>
    </div>

    <p className="text-center text-xs text-slate-400">
      {MAX_FILES - files.length} more file{MAX_FILES - files.length !== 1 ? 's' : ''} can be added
    </p>
  </div>
)}
```

**Step 5: Update the heading text.**

Change the heading from "Upload Your Files" to "Add Your Files" and update the description to mention Drive:

```tsx
<h2 className="text-xl font-semibold text-slate-900 mb-2">
  Add Your Files
</h2>
<p className="text-slate-500">
  Upload Excel files or select from Google Drive. You can add up to {MAX_FILES} files.
</p>
```

**Important things to preserve:**
- Keep the existing drag-and-drop handlers unchanged
- Keep the file cards section unchanged (it already renders FileDefinition objects)
- Keep the empty state unchanged
- Keep the file limit reached message unchanged
- Keep the error display unchanged
- Do NOT modify handleFiles, handleChangeSheet, handleChangeHeaderRow
- The `accept=".xlsx,.xls"` on the file input stays for local uploads (Drive handles all types via backend)

**Note on FileCard:** The existing FileCard component renders FileDefinition objects and shows file name, columns, sheet selector, etc. Drive files will render correctly because they have the same `name`, `filename`, `columns`, `sampleData` fields. The sheet selector will be hidden for Drive files because they won't have `availableSheets` (backend doesn't return sheet list from the download endpoint -- this is fine for Phase 4, sheet selection for Drive files is a Phase 5 concern).
  </action>
  <verify>
1. Run `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
2. Run `cd frontend && npm run build` -- Vite build succeeds
3. Verify FilesStep imports DriveFilePicker and useAuth
4. Verify the grid layout has two columns on md+ screens
5. Verify the Connect Google Drive button renders when driveConnected is false
6. Verify the DriveFilePicker renders when driveConnected is true
  </verify>
  <done>
- FilesStep shows dual-source input (local upload + Drive picker) side by side
- DriveFilePicker component wired with onAddDriveFile callback
- Users without Drive scopes see "Connect Google Drive" button that redirects to OAuth with Drive scopes
- Drag-and-drop for local files preserved and working
- File cards display both local and Drive files correctly
- TypeScript compiles cleanly, Vite build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Google Drive Picker integration in the workflow wizard:
- Dual-source file input (local upload + Drive picker) in FilesStep
- Google Picker opens and allows browsing My Drive and Shared Drives
- Selected Drive file is parsed by backend and appears as file card
- "Connect Google Drive" button shown for users without Drive scopes
- Drive files and local files can be mixed in the same workflow
  </what-built>
  <how-to-verify>
**Prerequisites:** Ensure `.env` file in `frontend/` has `VITE_GOOGLE_CLIENT_ID` and `VITE_GOOGLE_API_KEY` set. Start both backend and frontend dev servers.

1. Navigate to workflow creation wizard (create new workflow)
2. Verify the Files step shows two options side by side: "Upload from Computer" and either "Select from Google Drive" (if Drive connected) or "Connect Google Drive" (if not connected)
3. If "Connect Google Drive" shown:
   - Click it -- should redirect to Google OAuth with Drive scope consent
   - After granting, return to app and verify "Select from Google Drive" button now appears
4. Click "Select from Google Drive":
   - Google Picker popup should appear
   - Browse files in My Drive
   - If you have Shared Drives, verify they are accessible
5. Select an Excel or Google Sheets file:
   - Picker should close
   - Loading indicator should appear briefly
   - File should appear as a card with name, columns, and sample data
6. Upload a local file alongside the Drive file:
   - Both files should appear as cards
   - Proceed through wizard -- both files should work for key column matching
7. Verify drag-and-drop still works for local files
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- TypeScript compilation passes
2. `cd frontend && npm run build` -- production build succeeds
3. FilesStep renders dual-source input on the Files wizard step
4. Google Picker opens when "Select from Google Drive" is clicked
5. Selected Drive file appears as a file card with columns and preview data
6. "Connect Google Drive" redirects to OAuth with Drive scopes for unauthenticated users
7. Local file upload (drag-drop and click) continues to work unchanged
8. Mixed file sources (Drive + local) work in the same workflow
</verification>

<success_criteria>
- User can open Google Picker and browse Drive files (SELECT-01)
- User can see Shared Drives in the picker (SELECT-03)
- User can mix Drive files and local uploads (SELECT-04)
- Users without Drive scopes see "Connect Google Drive" button
- Selected Drive files return metadata to workflow editor
- Existing local upload functionality unbroken
- Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-picker-ui/04-02-SUMMARY.md`
</output>
