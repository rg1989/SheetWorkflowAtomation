---
phase: 05-workflow-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/pages/RunWorkflowPage.tsx
  - frontend/src/lib/api.ts
  - frontend/src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "User can pick a Drive file for a workflow input slot at run time"
    - "User can select which sheet tab to read from multi-tab Google Sheets"
    - "User sees preview of Drive file data after selection (before running workflow)"
    - "User sees warning if Drive file hasn't changed since last workflow run"
    - "User can run a workflow with mixed sources (some local, some Drive)"
    - "Existing local-only workflow runs continue to work unchanged"
  artifacts:
    - path: "frontend/src/pages/RunWorkflowPage.tsx"
      provides: "Drive file input, tab selector, preview, version warning, mixed-source run"
      contains: "useDriveFilePicker"
    - path: "frontend/src/lib/api.ts"
      provides: "Updated workflowApi.run supporting mixed sources, driveApi.getSheetTabs"
      contains: "getSheetTabs"
    - path: "frontend/src/types/index.ts"
      provides: "DriveRunFileState type for Drive files at run time"
      contains: "DriveRunFileState"
  key_links:
    - from: "frontend/src/pages/RunWorkflowPage.tsx"
      to: "frontend/src/hooks/useDriveFilePicker.ts"
      via: "Drive picker hook for file selection at run time"
      pattern: "useDriveFilePicker"
    - from: "frontend/src/pages/RunWorkflowPage.tsx"
      to: "frontend/src/lib/api.ts"
      via: "driveApi.getSheetTabs for tab listing, workflowApi.run for mixed execution"
      pattern: "driveApi\\.getSheetTabs|workflowApi\\.run"
    - from: "frontend/src/lib/api.ts"
      to: "backend/app/api/drive.py"
      via: "GET /drive/sheets/tabs endpoint call"
      pattern: "/drive/sheets/tabs"
    - from: "frontend/src/lib/api.ts"
      to: "backend/app/api/workflows.py"
      via: "POST /workflows/{id}/run with mixed file_configs"
      pattern: "/workflows/.*/run"
---

<objective>
Integrate Drive file selection into the RunWorkflowPage with tab selection, data preview, and version warnings, and update the API client to support mixed-source workflow runs.

Purpose: This plan completes Phase 5 by making the RunWorkflowPage work with Drive files in addition to local uploads. Users can pick Drive files for any workflow input slot, see a preview before running, choose specific tabs from Google Sheets files, and get warnings when files haven't changed since the last run. The API client is updated to send mixed-source run requests to the backend.

Output: Modified `RunWorkflowPage.tsx` with Drive integration, updated `api.ts` with mixed-source run and sheet tabs, new types in `index.ts`.
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-workflow-integration/05-01-SUMMARY.md

@frontend/src/pages/RunWorkflowPage.tsx
@frontend/src/lib/api.ts
@frontend/src/types/index.ts
@frontend/src/hooks/useDriveFilePicker.ts
@frontend/src/context/AuthContext.tsx
@frontend/src/components/WorkflowWizard/DriveFilePicker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add types and API client functions</name>
  <files>frontend/src/types/index.ts, frontend/src/lib/api.ts</files>
  <action>
**In `frontend/src/types/index.ts`:**

Add a new interface for Drive file state at run time (in the Google Drive Types section):

```typescript
/** State tracking for a Drive file selected at run time */
export interface DriveRunFileState {
  driveFileId: string
  driveMimeType: string
  driveModifiedTime?: string
  name: string
  validated: boolean
  error?: string
  columns?: ColumnInfo[]
  sampleData?: Record<string, unknown>[]
  rowCount?: number
  availableTabs?: Array<{ title: string; index: number; sheetId: number }>
  selectedTab?: string
  isLoading?: boolean
}
```

**In `frontend/src/lib/api.ts`:**

1. Add `getSheetTabs` to `driveApi`:
   ```typescript
   /** Fetch list of sheet tabs for a Google Sheets spreadsheet */
   getSheetTabs: (spreadsheetId: string) =>
     fetchJSON<{ tabs: Array<{ title: string; index: number; sheetId: number }> }>(
       `/drive/sheets/tabs?spreadsheet_id=${encodeURIComponent(spreadsheetId)}`
     ),
   ```

2. Update `workflowApi.run` to accept mixed sources. Change the signature to:
   ```typescript
   run: async (
     id: string,
     files: File[],
     fileConfigs: Record<string, {
       source?: 'local' | 'drive'
       sheetName?: string
       headerRow: number
       driveFileId?: string
       driveMimeType?: string
     }>
   ): Promise<RunResult> => {
   ```
   The body of the function remains the same -- `files` are the local File objects, `fileConfigs` is serialized as JSON. The backend now expects the extended config format. No change to the FormData construction is needed since Drive files are referenced by ID in fileConfigs (not sent as uploads).

   Note: Ensure `files` can be an empty array (for all-Drive workflows). The FormData should still work -- if files array is empty, no `files` fields are appended.
  </action>
  <verify>
Read `frontend/src/types/index.ts` and confirm `DriveRunFileState` interface exists.
Read `frontend/src/lib/api.ts` and confirm `driveApi.getSheetTabs` and updated `workflowApi.run` signature.
  </verify>
  <done>
Types and API client are ready for Drive file integration in the RunWorkflowPage. `DriveRunFileState` tracks Drive file state at run time. `driveApi.getSheetTabs` fetches tab list. `workflowApi.run` accepts mixed source configs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Drive files into RunWorkflowPage</name>
  <files>frontend/src/pages/RunWorkflowPage.tsx</files>
  <action>
This is the main integration task. Extend `RunWorkflowPage` to support Drive files alongside local uploads.

**1. Imports:**
Add imports for:
- `useDriveFilePicker` from `../hooks/useDriveFilePicker`
- `driveApi` from `../lib/api` (add to existing import)
- `useAuth` from `../context/AuthContext`
- `Cloud` icon from lucide-react (add to existing import)
- `DriveRunFileState`, `DrivePickerFile` from `../types`

**2. Add Drive file state:**
Add parallel state alongside `uploadedFiles`:
```typescript
const [driveFiles, setDriveFiles] = useState<Record<string, DriveRunFileState>>({})
```

**3. Drive file picker:**
For each expected file slot, add a "Pick from Drive" button alongside the existing "Upload" button. Use `useDriveFilePicker` hook (or inline the DriveFilePicker component pattern).

When user picks a Drive file for a slot:
- Call `driveApi.downloadFile(pickedFile.id)` to get metadata, columns, sample_data
- If the file is a Google Sheet (`mimeType === 'application/vnd.google-apps.spreadsheet'`), also call `driveApi.getSheetTabs(pickedFile.id)` to get available tabs
- Store result in `driveFiles[expectedFile.id]` as a `DriveRunFileState`
- Validate columns against expected columns (reuse `validateFileColumns`)
- If file has multiple tabs and validation fails, show tab selector (similar to sheet selector in local upload)
- Clear any existing local upload for this slot (and vice versa -- picking local clears Drive)

**4. Version warning (INPUT-04):**
When the expected file has `driveModifiedTime` stored from the workflow definition (meaning it was previously run with this Drive file):
- Compare stored `driveModifiedTime` from `expectedFile.driveModifiedTime` with the current file's `driveModifiedTime` from the download response
- If timestamps match (file hasn't changed), show an amber warning badge: "File unchanged since last run"
- Use `new Date()` comparison, NOT string comparison (per Pitfall 4 from research)
- This is a warning only -- do not block execution

**5. Tab selector (INPUT-05):**
When a Drive file is a Google Sheet with multiple tabs:
- Show a dropdown similar to the existing sheet selector for local files
- When user changes tab:
  - Call `driveApi.readSheet(driveFileId, tabTitle)` to get data for that specific tab
  - Update columns, sampleData, rowCount in DriveRunFileState
  - Re-validate columns

**6. Preview (INPUT-06):**
After selecting a Drive file, show a preview table of the first 10 rows:
- Use `sampleData` from the download response (already returns first 5 rows -- display all of them)
- Show columns as table headers, rows as table body
- Display row count badge: "X rows, Y columns"
- Reuse the same table styling used in the result preview section

**7. Update allFilesUploaded check:**
Change validation to check that each expected file has EITHER a validated local upload OR a validated Drive file:
```typescript
const allFilesReady = workflow?.files?.every(f =>
  uploadedFiles[f.id]?.validated || driveFiles[f.id]?.validated
) ?? false
```

**8. Update handleRun:**
When building `filesToSend` and `fileConfigs`:
- For slots with local uploads: add file to `filesToSend` array, set `source: "local"` in config
- For slots with Drive files: do NOT add to `filesToSend` array, set `source: "drive"` with `driveFileId`, `driveMimeType`, and `sheetName` (from selected tab) in config
- Pass the mixed arrays to `workflowApi.run(id, filesToSend, fileConfigs)`

**9. UI layout for each file slot:**
Modify each expected file card to show:
- File name and expected columns (existing)
- Two action buttons: "Upload" (existing) and "Pick from Drive" (new, with Cloud icon)
  - Only show "Pick from Drive" if user has Drive connected (check `useAuth().driveConnected`)
- If local file uploaded: show existing upload UI (sheet selector, header row, validation)
- If Drive file selected: show Drive file info (name, modified time), tab selector (if Sheets), preview table, version warning
- User can switch between local and Drive by clicking the other button

**10. Clearing state:**
- When user uploads local file for a slot: clear `driveFiles[slotId]`
- When user picks Drive file for a slot: clear `uploadedFiles[slotId]`

**Preserve all existing functionality.** The entire local file upload flow (drag-and-drop via file input, sheet selector, header row selector, column validation) must continue to work unchanged. The Drive integration is additive.
  </action>
  <verify>
Read `frontend/src/pages/RunWorkflowPage.tsx` and confirm:
- Drive file state management (`driveFiles` state)
- Drive picker button for each file slot (with Cloud icon)
- Tab selector for Google Sheets Drive files
- Preview table showing sample data
- Version warning when file hasn't changed
- Mixed-source run in `handleRun`
- `allFilesReady` checks both local and Drive
- Existing local upload flow is preserved
  </verify>
  <done>
RunWorkflowPage supports Drive files as workflow inputs. Users can pick Drive files, see preview data, select sheet tabs from Google Sheets, and get warnings for unchanged files. Mixed-source workflows (some local, some Drive) execute successfully. All existing local upload functionality is preserved.
  </done>
</task>

</tasks>

<verification>
1. Read `frontend/src/types/index.ts` -- confirm `DriveRunFileState` type exists
2. Read `frontend/src/lib/api.ts` -- confirm `driveApi.getSheetTabs` and mixed-source `workflowApi.run`
3. Read `frontend/src/pages/RunWorkflowPage.tsx` -- confirm Drive integration with all 5 success criteria
4. Verify no broken imports or missing type references
5. Verify existing local upload flow is unchanged (preserve all event handlers, validation logic)
</verification>

<success_criteria>
- Each file slot shows "Upload" and "Pick from Drive" buttons
- Picking a Drive file shows preview data (columns + sample rows)
- Google Sheets with multiple tabs show a tab selector dropdown
- Files unchanged since last run show amber warning badge
- "Run Workflow" button enabled when all slots have validated files (any source)
- Running with mixed sources (some local, some Drive) succeeds
- Running with all local files still works (backward compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/05-workflow-integration/05-02-SUMMARY.md`
</output>
