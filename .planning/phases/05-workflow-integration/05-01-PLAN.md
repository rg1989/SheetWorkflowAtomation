---
phase: 05-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/api/workflows.py
  - backend/app/api/drive.py
autonomous: true

must_haves:
  truths:
    - "Workflow run endpoint accepts Drive file references alongside local uploads"
    - "Drive files are downloaded and parsed into DataFrames at execution time"
    - "Mixed source workflows (some local, some Drive) execute successfully"
    - "Frontend can fetch sheet tab list for a Google Sheets spreadsheet"
  artifacts:
    - path: "backend/app/api/workflows.py"
      provides: "Extended run_workflow endpoint with Drive file support"
      contains: "download_drive_file_to_df"
    - path: "backend/app/api/drive.py"
      provides: "Sheet tabs endpoint"
      contains: "get_sheet_tabs"
  key_links:
    - from: "backend/app/api/workflows.py"
      to: "backend/app/services/drive.py"
      via: "download_drive_file_to_df for Drive files during workflow execution"
      pattern: "download_drive_file_to_df"
    - from: "backend/app/api/workflows.py"
      to: "backend/app/services/google_auth.py"
      via: "build_drive_service and build_sheets_service for authenticated API access"
      pattern: "build_drive_service|build_sheets_service"
    - from: "backend/app/api/drive.py"
      to: "backend/app/services/sheets.py"
      via: "get_sheet_tabs for listing spreadsheet tabs"
      pattern: "get_sheet_tabs"
---

<objective>
Extend the workflow run endpoint to accept Drive file references alongside local uploads, and add a sheet tabs listing endpoint.

Purpose: This is the backend foundation for Phase 5's workflow integration. Currently `POST /workflows/{id}/run` only accepts local file uploads via multipart/form-data. It must also handle Drive file references so that workflows can execute with a mix of local and Drive file inputs. Additionally, the frontend needs an endpoint to list sheet tabs from a Google Sheets file so users can choose which tab to read at run time.

Output: Modified `workflows.py` with mixed-source run logic, new `/drive/sheets/tabs` endpoint in `drive.py`.
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@backend/app/api/workflows.py
@backend/app/api/drive.py
@backend/app/services/drive.py
@backend/app/services/sheets.py
@backend/app/services/google_auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend workflow run endpoint for mixed file sources</name>
  <files>backend/app/api/workflows.py</files>
  <action>
Modify `POST /{workflow_id}/run` to handle both local uploads and Drive file references.

**Key changes:**

1. Change `files` parameter from required to optional: `files: List[UploadFile] = File(default=[])` -- Drive-only workflows may have zero local uploads.

2. The existing `file_configs` JSON string already maps file IDs to `{sheetName, headerRow}`. Extend its expected format to include Drive source info:
   ```json
   {
     "fileId1": {
       "source": "local",
       "sheetName": "Sheet1",
       "headerRow": 1
     },
     "fileId2": {
       "source": "drive",
       "driveFileId": "1ABCxyz...",
       "driveMimeType": "application/vnd.google-apps.spreadsheet",
       "sheetName": "Sales Data",
       "headerRow": 1
     }
   }
   ```

3. Replace the current validation `if len(files) != len(expected_files)` with logic that counts how many local files are expected vs how many are uploaded:
   - Count expected local files = configs where `source` is `"local"` or missing (backward compat)
   - Validate `len(files) == expected_local_count`

4. In the file processing loop, route based on `config.get("source", "local")`:
   - For `"local"` files: Use existing logic (save to temp, parse with ExcelParser)
   - For `"drive"` files:
     - Import and call `build_drive_service` and `build_sheets_service` from `app.services.google_auth`
     - Import `download_drive_file_to_df` from `app.services.drive`
     - Import `read_sheet_to_df` from `app.services.sheets`
     - Call `get_valid_access_token` before each Drive file to avoid stale tokens per Pitfall 3
     - If `driveMimeType == "application/vnd.google-apps.spreadsheet"` and `sheetName` is provided, use `read_sheet_to_df(sheets_service, driveFileId, range_name=sheetName)` for tab-specific reads
     - Otherwise use `download_drive_file_to_df(drive_service, driveFileId, mime_type=driveMimeType, sheets_service=sheets_service)`

5. Build Drive/Sheets services ONCE outside the loop (not per-file) for efficiency. The `get_valid_access_token` call inside `_build_credentials` already handles refresh.

6. Track local file index separately: maintain a `local_file_index` counter that only increments when processing local files.

7. Update `input_files` JSON in RunDB to include Drive file metadata for audit trail:
   ```python
   input_files=json.dumps({
       "files": file_info_list,  # Mix of filenames and Drive IDs
       "configs": configs,
   })
   ```

8. Add imports at top:
   ```python
   from app.services.google_auth import build_drive_service, build_sheets_service
   from app.services.drive import download_drive_file_to_df
   from app.services.sheets import read_sheet_to_df
   ```

9. Wrap Drive download errors in a try/except that adds context about which file failed:
   ```python
   except Exception as drive_err:
       raise HTTPException(
           status_code=400,
           detail=f"Failed to download Drive file '{config.get('driveFileId')}': {str(drive_err)}"
       )
   ```

**Backward compatibility:** When `source` key is missing from a file config, default to `"local"`. This preserves existing API behavior.
  </action>
  <verify>
Read the modified `workflows.py` and confirm:
- `files` parameter is `File(default=[])` (optional)
- Drive service imports are present
- Processing loop routes on `config.get("source", "local")`
- Local file count validation is correct
- Drive files call `download_drive_file_to_df` or `read_sheet_to_df`
- Drive download errors are wrapped in try/except with HTTPException (status_code=400, detail includes driveFileId)
- Backward compatibility with missing `source` key
  </verify>
  <done>
The workflow run endpoint accepts a mix of local uploads and Drive file references. Drive files are downloaded and parsed into DataFrames at execution time. Workflows with zero local files (all Drive) work. Existing API callers without `source` field continue to work unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sheet tabs listing endpoint</name>
  <files>backend/app/api/drive.py</files>
  <action>
Add a `GET /sheets/tabs` endpoint to `drive.py` that lists all sheet tabs for a Google Sheets spreadsheet.

1. Add a new endpoint:
   ```python
   @router.get("/sheets/tabs")
   async def list_sheet_tabs(
       spreadsheet_id: str,
       current_user: UserDB = Depends(get_current_user),
       db: AsyncSession = Depends(get_db)
   ):
   ```

2. Inside the handler:
   - Build sheets service: `sheets_service = await build_sheets_service(current_user, db)`
   - Import and call: `from app.services.sheets import get_sheet_tabs`
   - Return: `{"tabs": tabs}` where tabs is the list from `get_sheet_tabs(sheets_service, spreadsheet_id)`

3. Add the import for `get_sheet_tabs` at the top of the file (it's already partially imported -- add to existing import line from `app.services.sheets`).

4. Handle errors:
   - Wrap in try/except for ValueError (Drive not connected) -> 401
   - The `get_sheet_tabs` function already has `@drive_retry` and `_handle_drive_error` for 403/404/429

The endpoint is simple because `get_sheet_tabs` already exists in `sheets.py` (built in Phase 2).
  </action>
  <verify>
Read the modified `drive.py` and confirm:
- `GET /sheets/tabs` endpoint exists with `spreadsheet_id` query parameter
- Uses `get_sheet_tabs` from `app.services.sheets`
- Returns `{"tabs": [...]}` with title, index, sheetId per tab
- Error handling for Drive not connected (401)
  </verify>
  <done>
Frontend can fetch the list of sheet tabs for any Google Sheets file via `GET /api/drive/sheets/tabs?spreadsheet_id=...`. Returns tab metadata (title, index, sheetId) for populating a tab selector dropdown.
  </done>
</task>

</tasks>

<verification>
1. Read `backend/app/api/workflows.py` -- confirm mixed-source run logic with Drive file download
2. Read `backend/app/api/drive.py` -- confirm `/sheets/tabs` endpoint exists
3. Verify imports are correct and no circular dependencies
4. Verify backward compatibility: configs without `source` field default to `"local"`
</verification>

<success_criteria>
- `POST /workflows/{id}/run` accepts file_configs with `source: "drive"` entries and downloads Drive files at execution time
- `POST /workflows/{id}/run` still works with existing local-only file_configs (backward compat)
- `GET /drive/sheets/tabs?spreadsheet_id=X` returns list of sheet tabs
- Drive files use `download_drive_file_to_df` or `read_sheet_to_df` based on MIME type and sheet selection
</success_criteria>

<output>
After completion, create `.planning/phases/05-workflow-integration/05-01-SUMMARY.md`
</output>
